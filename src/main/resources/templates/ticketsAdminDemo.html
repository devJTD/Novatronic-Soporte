<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Tickets — Panel Administrador</title>
  <link rel="stylesheet" href="../static/css/ticketAdminDemo.css" />
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div class="logo" aria-hidden="true">IT</div>
        <div>
          <h1 class="h1">Registro de Tickets</h1>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap wide" aria-live="polite">
    <section class="card">
      <div class="head">
        <h2 class="h2" style="margin:0; font-size:18px">Nuevo Ticket</h2>
        <div class="pills" aria-label="Leyenda de prioridad">
          <span class="pill p1">P1 Crítica</span>
          <span class="pill p2">P2 Alta</span>
          <span class="pill p3">P3 Media</span>
          <span class="pill p4">P4 Baja</span>
        </div>
      </div>
      <div class="body">
        <form id="ticketForm" autocomplete="on">
          <!-- Identificación del cliente / empresa -->
          <fieldset class="col-12">
            <legend>Datos del cliente</legend>
            <div class="grid">
              <div class="col-6">
                <label for="empresa">Empresa que reporta *</label>
                <input id="empresa" name="empresa" required placeholder="Ej: Novatronic S.A." />
              </div>
              <div class="col-3">
                <label for="ruc">RUC (opcional)</label>
                <input id="ruc" name="ruc" placeholder="Ej: 20123456789" />
              </div>
              <div class="col-3">
                <label for="canal">Canal de recepción</label>
                <select id="canal" name="canal">
                  <option>Web</option>
                  <option>Correo</option>
                  <option>Teléfono</option>
                  <option>WhatsApp</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="col-4">
                <label for="reporta">Persona que reporta *</label>
                <input id="reporta" name="reporta" required placeholder="Nombre y apellido" />
              </div>
              <div class="col-4">
                <label for="email">Correo *</label>
                <input id="email" name="email" type="email" required placeholder="correo@empresa.com" />
              </div>
              <div class="col-4">
                <label for="telefono">Teléfono</label>
                <input id="telefono" name="telefono" placeholder="Ej: +51 999 999 999" />
              </div>
            </div>
          </fieldset>

          <!-- Datos del ticket -->
          <fieldset class="col-12">
            <legend>Detalle del ticket</legend>
            <div class="grid">
              <div class="col-8">
                <label for="asunto">Asunto *</label>
                <input id="asunto" name="asunto" required placeholder="Ej: Caída de servicio de facturación" />
              </div>
              <div class="col-4">
                <label for="categoria">Categoría *</label>
                <select id="categoria" name="categoria" required>
                  <option value="Incidente">Incidente</option>
                  <option value="Requerimiento">Requerimiento</option>
                  <option value="Problema">Problema</option>
                  <option value="Consulta">Consulta</option>
                </select>
              </div>
              <div class="col-12">
                <label for="descripcion">Descripción *</label>
                <textarea id="descripcion" name="descripcion" required placeholder="Describe el síntoma, alcance y pasos realizados…"></textarea>
                <p class="hint">Incluye fecha y hora de inicio, pantallazos y cualquier código de error.</p>
              </div>
              <div class="col-4">
                <label for="impacto">Impacto</label>
                <select id="impacto" name="impacto">
                  <option>Baja</option>
                  <option>Media</option>
                  <option>Alta</option>
                  <option>Crítica</option>
                </select>
              </div>
              <div class="col-4">
                <label for="urgencia">Urgencia</label>
                <select id="urgencia" name="urgencia">
                  <option>Baja</option>
                  <option>Media</option>
                  <option>Alta</option>
                  <option>Crítica</option>
                </select>
              </div>
              <div class="col-4">
                <label for="prioridad">Prioridad *</label>
                <select id="prioridad" name="prioridad" required>
                  <option>P4 - Baja</option>
                  <option>P3 - Media</option>
                  <option selected>P2 - Alta</option>
                  <option>P1 - Crítica</option>
                </select>
                <div class="row" style="margin-top:8px">
                  <label class="toggle" title="Si está activo, la prioridad se calcula con Impacto y Urgencia">
                    <input id="autoPriority" type="checkbox" checked />
                    <span class="switch" aria-hidden="true"></span>
                    <span style="font-size:12px; color:var(--subtle)">Calcular prioridad automáticamente</span>
                  </label>
                </div>
              </div>
              <div class="col-6">
                <label for="adjuntos">Adjuntos</label>
                <input id="adjuntos" name="adjuntos" type="file" multiple />
                <p class="hint" id="filesHint">Máx. 10 archivos. Imagen, PDF o ZIP.</p>
              </div>
              <div class="col-6">
                <label for="tags">Etiquetas</label>
                <input id="tags" name="tags" placeholder="Ej: base de datos, producción, v1.2.3" />
                <p class="hint">Separa por comas para facilitar la búsqueda.</p>
              </div>
            </div>
          </fieldset>

          <!-- Asignación y SLA -->
          <fieldset class="col-12">
            <legend>Asignación y control</legend>
            <div class="grid">
              <div class="col-4">
                <label for="grupo">Grupo / Área</label>
                <select id="grupo" name="grupo">
                  <option>Service Desk</option>
                  <option>Infraestructura</option>
                  <option>Aplicaciones</option>
                  <option>Redes</option>
                  <option>Seguridad</option>
                </select>
              </div>
              <div class="col-4">
                <label for="asignado">Asignar a</label>
                <input id="asignado" name="asignado" placeholder="Ej: Juan Pérez" />
              </div>
              <div class="col-4">
                <label for="estado">Estado</label>
                <select id="estado" name="estado">
                  <option>Nuevo</option>
                  <option>En progreso</option>
                  <option>En espera</option>
                  <option>Resuelto</option>
                  <option>Cerrado</option>
                </select>
              </div>
              <div class="col-4">
                <label for="due">Fecha límite (SLA)</label>
                <input id="due" name="due" type="datetime-local" />
                <p class="hint">Se sugiere según la prioridad.</p>
              </div>
              <div class="col-8">
                <label>Objetivo de SLA</label>
                <div class="sla-box" id="slaBox">Para <b>P2 - Alta</b>: responder en <b>4 horas</b>. Resolver según ANS vigente.</div>
              </div>
            </div>
          </fieldset>

          <div class="actions col-12">
            <button class="btn btn-primary" type="submit" id="submitBtn">Registrar ticket</button>
            <button class="btn btn-warn" type="button" id="draftBtn">Guardar borrador</button>
            <button class="btn btn-danger" type="reset">Limpiar</button>
            <button class="btn btn-ghost" type="button" id="demoBtn">Autocompletar demo</button>
          </div>
        </form>
      </div>
    </section>

    <div style="height:18px"></div>

    <section class="card">
      <div class="head">
        <h2 class="h2" style="margin:0; font-size:18px">Tickets creados (vista local)</h2>
      </div>
      <div class="body" style="overflow:auto">
        <table class="table" id="ticketsTable" aria-describedby="Tabla de tickets creados localmente">
          <thead>
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Empresa</th>
              <th>Asunto</th>
              <th>Prioridad</th>
              <th>Estado</th>
              <th>Asignado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    /* ====== Persistencia en ejecución (sessionStorage) ====== */
    const STORAGE_KEY = 'ticketsSessionV1';

    // Utilidades UI
    const $  = (q, c=document) => c.querySelector(q);
    const $$ = (q, c=document) => Array.from(c.querySelectorAll(q));

    const SLA_MAP = {
      'P1 - Crítica': '1 hora',
      'P2 - Alta': '4 horas',
      'P3 - Media': '1 día hábil',
      'P4 - Baja': '3 días hábiles'
    };
    const scale = { 'Baja':1, 'Media':2, 'Alta':3, 'Crítica':4 };

    let tickets = JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '[]');

    function saveSession(){
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
    }
    function showToast(msg){
      const t = $('#toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2500);
    }

    function computePriority(impacto, urgencia){
      const score = Math.max(scale[impacto] || 1, scale[urgencia] || 1);
      if(score >= 4) return 'P1 - Crítica';
      if(score === 3) return 'P2 - Alta';
      if(score === 2) return 'P3 - Media';
      return 'P4 - Baja';
    }

    function updateSLA(){
      const prioridad = $('#prioridad').value;
      const txt = SLA_MAP[prioridad] || 'Definir';
      $('#slaBox').innerHTML = `Para <b>${prioridad}</b>: responder en <b>${txt}</b>. Resolver según ANS vigente.`;
      const now = new Date();
      const d = new Date(now);
      if(prioridad.startsWith('P1')) d.setHours(d.getHours()+1);
      else if(prioridad.startsWith('P2')) d.setHours(d.getHours()+4);
      else if(prioridad.startsWith('P3')) d.setDate(d.getDate()+1);
      else d.setDate(d.getDate()+3);
      const pad = n => String(n).padStart(2,'0');
      $('#due').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function renderPriorityPill(p){
      const cls = p.startsWith('P1')? 'p1' : p.startsWith('P2')? 'p2' : p.startsWith('P3')? 'p3' : 'p4';
      return `<span class="pill ${cls}">${escapeHtml(p)}</span>`;
    }

    // Render de la tabla desde sessionStorage
    function renderTable(){
      const tbody = $('#ticketsTable tbody');
      tbody.innerHTML = '';
      // Mostrar del más reciente al más antiguo
      tickets.slice().reverse().forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><code>${escapeHtml(t.id)}</code></td>
          <td>${new Date(t.createdAt).toLocaleString()}</td>
          <td>${escapeHtml(t.empresa || '')}</td>
          <td title="${escapeHtml(t.descripcion || '')}">${escapeHtml(t.asunto || '')}</td>
          <td>${renderPriorityPill(t.prioridad || 'P3 - Media')}</td>
          <td>${escapeHtml(t.estado || 'Nuevo')}</td>
          <td>${escapeHtml(t.asignado || '-')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ====== Eventos del formulario ======
    $('#autoPriority').addEventListener('change', (e)=>{
      const auto = e.target.checked;
      $('#prioridad').disabled = auto;
      if(auto){
        $('#prioridad').value = computePriority($('#impacto').value, $('#urgencia').value);
      }
      updateSLA();
    });

    $('#impacto').addEventListener('change', ()=>{
      if($('#autoPriority').checked){
        $('#prioridad').value = computePriority($('#impacto').value, $('#urgencia').value);
        updateSLA();
      }
    });

    // (Corrección) usar impacto, urgencia en ese orden
    $('#urgencia').addEventListener('change', ()=>{
      if($('#autoPriority').checked){
        $('#prioridad').value = computePriority($('#impacto').value, $('#urgencia').value);
        updateSLA();
      }
    });

    $('#prioridad').addEventListener('change', updateSLA);

    $('#adjuntos').addEventListener('change', (e)=>{
      const n = e.target.files?.length || 0;
      $('#filesHint').textContent = n ? `${n} archivo(s) seleccionado(s)` : 'Máx. 10 archivos. Imagen, PDF o ZIP.';
    });

    $('#demoBtn').addEventListener('click', ()=>{
      $('#empresa').value = 'Novatronic S.A.';
      $('#ruc').value = '20123456789';
      $('#canal').value = 'Correo';
      $('#reporta').value = 'Andrea Gómez';
      $('#email').value = 'andrea.gomez@novatronic.com';
      $('#telefono').value = '+51 999 123 456';
      $('#asunto').value = 'Interrupción parcial en servicio de pagos';
      $('#categoria').value = 'Incidente';
      $('#descripcion').value = 'Clientes reportan errores 502 en el flujo de cobros. Afecta a producción, región Lima. Inició 10:20 AM. Se adjuntan logs.';
      $('#impacto').value = 'Alta';
      $('#urgencia').value = 'Alta';
      if($('#autoPriority').checked){
        $('#prioridad').value = computePriority('Alta', 'Alta');
      } else {
        $('#prioridad').value = 'P2 - Alta';
      }
      $('#grupo').value = 'Aplicaciones';
      $('#asignado').value = 'Juan Pérez';
      $('#estado').value = 'Nuevo';
      updateSLA();
      showToast('Campos de demo cargados');
    });

    $('#draftBtn').addEventListener('click', ()=>{
      const data = Object.fromEntries(new FormData($('#ticketForm')).entries());
      localStorage.setItem('ticketDraft', JSON.stringify(data));
      showToast('Borrador guardado localmente');
    });

    window.addEventListener('load', ()=>{
      // Restaura borrador (si hubo)
      if(localStorage.getItem('ticketDraft')){
        try{
          const d = JSON.parse(localStorage.getItem('ticketDraft'));
          for(const [k,v] of Object.entries(d)){
            if($('#'+k)) $('#'+k).value = v;
          }
        }catch{ /* ignore */ }
      }
      if($('#autoPriority').checked){
        $('#prioridad').value = computePriority($('#impacto').value, $('#urgencia').value);
      }
      updateSLA();
      renderTable(); // <-- pinta tickets guardados en la sesión actual
    });

    $('#ticketForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const form = e.currentTarget;
      if(!form.reportValidity()) return;

      const fd  = new FormData(form);
      const data = Object.fromEntries(fd.entries());
      const now = new Date();
      const id  = `TCK-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}-${Math.random().toString(36).slice(2,8).toUpperCase()}`;

      // Construye el objeto de ticket que se persistirá en sessionStorage
      const ticket = {
        id,
        createdAt: now.toISOString(),
        empresa: data.empresa || '',
        ruc: data.ruc || '',
        canal: data.canal || '',
        reporta: data.reporta || '',
        email: data.email || '',
        telefono: data.telefono || '',
        asunto: data.asunto || '',
        descripcion: data.descripcion || '',
        categoria: data.categoria || '',
        impacto: data.impacto || '',
        urgencia: data.urgencia || '',
        prioridad: data.prioridad || '',
        grupo: data.grupo || '',
        asignado: data.asignado || '',
        estado: data.estado || 'Nuevo',
        due: data.due || '',
        tags: data.tags || ''
      };

      // Guarda en sessionStorage (persistencia de la ejecución)
      tickets.push(ticket);
      saveSession();
      renderTable();

      // Limpieza parcial, conservando datos de contacto
      const keep = new Set(['empresa','ruc','reporta','email','telefono']);
      $$('input, textarea, select', form).forEach(el=>{
        if(keep.has(el.id)) return;
        if(el.type === 'file') el.value = '';
        else if(el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
      if($('#autoPriority').checked){
        $('#prioridad').value = computePriority($('#impacto').value, $('#urgencia').value);
      }
      updateSLA();

      showToast('Ticket guardado en la sesión (sin backend)');
    });
  </script>
</body>
</html>