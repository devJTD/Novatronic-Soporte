<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novatronic - Reportes y Análisis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/nova-styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-glass fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/admin/dashboard">
                <img src="/img/logo.png" alt="Novatronic">
                <span class="badge bg-danger ms-2">ADMIN</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/admin/dashboard"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/tickets-revisados"><i class="bi bi-list-check"></i> Gestión Tickets</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/admin/reportes"><i class="bi bi-graph-up"></i> Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/admin/base-conocimiento"><i class="bi bi-book"></i> Base Conocimiento</a></li>
                </ul>
                <div class="d-flex align-items-center">
                    <span class="text-white me-3"><i class="bi bi-person-circle"></i> Admin</span>
                    <a class="btn btn-sm btn-nova btn-nova-danger" href="/login"><i class="bi bi-box-arrow-right"></i> Salir</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-4xl font-bold text-white mb-2">
                    <i class="bi bi-bar-chart-line-fill"></i> Reportes y Análisis de Desempeño
                </h1>
                <p class="text-glass-muted">Req 15, 16, 17: Generación, análisis de tendencias y exportación de datos</p>
            </div>
        </div>

        <!-- Req 15: Filtros de Período -->
        <div class="card-glass mb-6">
            <div class="card-glass-body">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label-glass">Período de Análisis</label>
                        <select class="form-glass w-full" id="periodo">
                            <option value="week">Última Semana</option>
                            <option value="month" selected>Último Mes</option>
                            <option value="quarter">Último Trimestre</option>
                            <option value="year">Último Año</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-glass">Cliente</label>
                        <select class="form-glass w-full" id="filterCliente">
                            <option value="" selected>Todos</option>
                            <option value="banco">Banco Central</option>
                            <option value="financiera">Financiera Alfa</option>
                            <option value="innova">Grupo Innova</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-glass">Categoría</label>
                        <select class="form-glass w-full" id="filterCategoria">
                            <option value="" selected>Todas</option>
                            <option value="incidente">Incidentes</option>
                            <option value="requerimiento">Requerimientos</option>
                            <option value="consulta">Consultas</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label-glass">Grupo</label>
                        <select class="form-glass w-full" id="filterGrupo">
                            <option value="" selected>Todos</option>
                            <option value="infra">Infraestructura</option>
                            <option value="dev">Desarrollo</option>
                            <option value="n1">Soporte N1</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-nova btn-nova-primary w-full" onclick="generarReporte()">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs Principales de Desempeño -->
        <div class="row g-4 mb-6">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card-3d">
                    <div>
                        <div class="kpi-label mb-2">Total Tickets Procesados</div>
                        <div class="kpi-number">1,245</div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="badge-modern" style="background: var(--gradient-success);">
                                <i class="bi bi-arrow-up"></i> +12.3%
                            </span>
                            <span class="text-sm text-glass-muted">vs mes anterior</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card-3d">
                    <div>
                        <div class="kpi-label mb-2">Cumplimiento SLA Global</div>
                        <div class="kpi-number">97.8%</div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="badge-modern" style="background: var(--gradient-success);">
                                <i class="bi bi-check-circle"></i> Meta: 95%
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card-3d">
                    <div>
                        <div class="kpi-label mb-2">Tiempo Promedio Resolución</div>
                        <div class="kpi-number">4.2h</div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="badge-modern" style="background: var(--gradient-warning);">
                                <i class="bi bi-arrow-down"></i> -0.8h
                            </span>
                            <span class="text-sm text-glass-muted">Mejora continua</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="kpi-card-3d">
                    <div>
                        <div class="kpi-label mb-2">Satisfacción Cliente (CSAT)</div>
                        <div class="kpi-number">4.6<span class="text-2xl">/5</span></div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="badge-modern" style="background: var(--gradient-success);">
                                <i class="bi bi-star-fill"></i> Excelente
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Req 16: Análisis de Tendencias y Debilidades (OPF) -->
        <div class="row g-4 mb-6">
            <div class="col-lg-6">
                <div class="card-glass">
                    <div class="card-glass-header bg-gradient-danger">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Áreas Críticas y Debilidades (OPF)
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <h4 class="text-white mb-3">Módulos con Mayor Tasa de Fallas</h4>
                        
                        <!-- Módulo 1 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-2">
                                <div>
                                    <span class="font-bold text-white">Módulo de Pagos</span>
                                    <span class="badge-modern badge-critica ml-2">CRÍTICO</span>
                                </div>
                                <span class="text-danger font-bold">38 incidentes</span>
                            </div>
                            <div class="relative h-3 bg-white bg-opacity-10 rounded-full">
                                <div class="absolute h-full bg-gradient-danger rounded-full" style="width: 85%;"></div>
                            </div>
                            <div class="text-xs text-glass-muted mt-1">
                                Tasa de re-apertura: 15.8% | Tiempo promedio resolución: 6.2h
                            </div>
                        </div>

                        <!-- Módulo 2 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-2">
                                <div>
                                    <span class="font-bold text-white">Base de Datos</span>
                                    <span class="badge-modern badge-alta ml-2">ALTO</span>
                                </div>
                                <span class="text-warning font-bold">25 incidentes</span>
                            </div>
                            <div class="relative h-3 bg-white bg-opacity-10 rounded-full">
                                <div class="absolute h-full bg-gradient-warning rounded-full" style="width: 60%;"></div>
                            </div>
                            <div class="text-xs text-glass-muted mt-1">
                                Tasa de re-apertura: 12.0% | Tiempo promedio resolución: 5.1h
                            </div>
                        </div>

                        <!-- Módulo 3 -->
                        <div class="mb-4">
                            <div class="flex justify-between mb-2">
                                <div>
                                    <span class="font-bold text-white">Módulo de Reportes</span>
                                    <span class="badge-modern badge-media ml-2">MEDIO</span>
                                </div>
                                <span class="text-info font-bold">18 incidentes</span>
                            </div>
                            <div class="relative h-3 bg-white bg-opacity-10 rounded-full">
                                <div class="absolute h-full bg-gradient-info rounded-full" style="width: 45%;"></div>
                            </div>
                            <div class="text-xs text-glass-muted mt-1">
                                Tasa de re-apertura: 8.3% | Tiempo promedio resolución: 4.5h
                            </div>
                        </div>

                        <hr class="border-white border-opacity-20 my-3">

                        <h4 class="text-white mb-3">Tickets Reabiertos (Req 16)</h4>
                        <div class="bg-warning bg-opacity-10 border border-warning border-opacity-30 rounded-lg p-3">
                            <div class="flex items-center gap-3">
                                <i class="bi bi-arrow-repeat text-warning text-3xl"></i>
                                <div>
                                    <div class="font-bold text-white text-xl">47 tickets</div>
                                    <div class="text-sm text-glass-muted">reabiertos en el último mes (3.8% del total)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card-glass">
                    <div class="card-glass-header bg-gradient-success">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-trophy-fill"></i> Mejores Prácticas y Fortalezas
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <h4 class="text-white mb-3">Módulos con Mejor Desempeño</h4>
                        
                        <div class="space-y-3 mb-4">
                            <div class="p-3 rounded-lg" style="background: rgba(56, 239, 125, 0.1); border: 1px solid rgba(56, 239, 125, 0.3);">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-white">Seguridad y Accesos</div>
                                        <div class="text-xs text-glass-muted">SLA: 99.2% | Re-apertura: 1.5%</div>
                                    </div>
                                    <span class="badge-modern" style="background: var(--gradient-success);">
                                        ⭐ Excelente
                                    </span>
                                </div>
                            </div>

                            <div class="p-3 rounded-lg" style="background: rgba(79, 172, 254, 0.1); border: 1px solid rgba(79, 172, 254, 0.3);">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="font-bold text-white">API / Integraciones</div>
                                        <div class="text-xs text-glass-muted">SLA: 98.5% | Re-apertura: 2.1%</div>
                                    </div>
                                    <span class="badge-modern" style="background: var(--gradient-info);">
                                        ✓ Muy Bueno
                                    </span>
                                </div>
                            </div>
                        </div>

                        <hr class="border-white border-opacity-20 my-3">

                        <h4 class="text-white mb-3">Agentes Top Performers</h4>
                        <div class="space-y-2">
                            <div class="flex items-center justify-between p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold" style="background: var(--gradient-primary);">1</div>
                                    <div>
                                        <div class="font-bold text-white">Laura Gómez</div>
                                        <div class="text-xs text-glass-muted">95 tickets | SLA: 99.1%</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-success font-bold">4.8/5</div>
                                    <div class="text-xs text-glass-muted">CSAT</div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold" style="background: var(--gradient-primary);">2</div>
                                    <div>
                                        <div class="font-bold text-white">Juan Pérez</div>
                                        <div class="text-xs text-glass-muted">88 tickets | SLA: 97.8%</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-success font-bold">4.7/5</div>
                                    <div class="text-xs text-glass-muted">CSAT</div>
                                </div>
                            </div>

                            <div class="flex items-center justify-between p-2 rounded" style="background: rgba(255,255,255,0.05);">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold" style="background: var(--gradient-primary);">3</div>
                                    <div>
                                        <div class="font-bold text-white">Pedro Ríos</div>
                                        <div class="text-xs text-glass-muted">76 tickets | SLA: 96.5%</div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-success font-bold">4.6/5</div>
                                    <div class="text-xs text-glass-muted">CSAT</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos de Análisis -->
        <div class="row g-4 mb-6">
            <div class="col-lg-8">
                <div class="card-glass">
                    <div class="card-glass-header">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-graph-up"></i> Tendencia de Tickets - Último Trimestre
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <canvas id="chartTendencia" height="100"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card-glass">
                    <div class="card-glass-header">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-pie-chart-fill"></i> Distribución por Tipo (IRP)
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <canvas id="chartTipos" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de SLA por Cliente -->
        <div class="row g-4 mb-6">
            <div class="col-lg-6">
                <div class="card-glass">
                    <div class="card-glass-header">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-speedometer"></i> Cumplimiento SLA por Cliente
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <canvas id="chartSLA" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card-glass">
                    <div class="card-glass-header">
                        <h3 class="text-xl font-bold mb-0">
                            <i class="bi bi-clock-history"></i> Tiempo Promedio de Resolución por Prioridad
                        </h3>
                    </div>
                    <div class="card-glass-body">
                        <canvas id="chartTiempos" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Req 17: Exportación de Datos -->
        <div class="card-glass">
            <div class="card-glass-header bg-gradient-info">
                <h3 class="text-xl font-bold mb-0">
                    <i class="bi bi-download"></i> Exportación de Reportes
                </h3>
            </div>
            <div class="card-glass-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <h4 class="text-white text-lg mb-3">Reportes Predefinidos</h4>
                        <div class="d-grid gap-2">
                            <button class="btn btn-nova" style="background: var(--gradient-success); color: white;" onclick="exportarExcel('completo')">
                                <i class="bi bi-file-earmark-excel"></i> Reporte Completo (Excel)
                            </button>
                            <button class="btn btn-nova" style="background: var(--gradient-danger); color: white;" onclick="exportarPDF('ejecutivo')">
                                <i class="bi bi-file-earmark-pdf"></i> Resumen Ejecutivo (PDF)
                            </button>
                            <button class="btn btn-nova" style="background: var(--gradient-info); color: white;" onclick="exportarExcel('sla')">
                                <i class="bi bi-file-earmark-spreadsheet"></i> Análisis SLA Detallado (Excel)
                            </button>
                            <button class="btn btn-nova" style="background: var(--gradient-warning); color: white;" onclick="exportarCSV('raw')">
                                <i class="bi bi-filetype-csv"></i> Datos Crudos (CSV)
                            </button>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h4 class="text-white text-lg mb-3">Exportación Personalizada</h4>
                        <div class="mb-3">
                            <label class="form-label-glass">Rango de Fechas</label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="date" class="form-glass w-full" id="fechaInicio">
                                </div>
                                <div class="col-6">
                                    <input type="date" class="form-glass w-full" id="fechaFin">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label-glass">Formato de Exportación</label>
                            <select class="form-glass w-full" id="formatoExport">
                                <option value="xlsx">Excel (.xlsx)</option>
                                <option value="pdf">PDF Detallado</option>
                                <option value="csv">CSV</option>
                                <option value="json">JSON (API)</option>
                            </select>
                        </div>
                        <button class="btn btn-nova btn-nova-primary w-full btn-lg" onclick="exportarPersonalizado()">
                            <i class="bi bi-download"></i> Generar y Descargar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Gráfico de Tendencia
        const ctxTendencia = document.getElementById('chartTendencia').getContext('2d');
        new Chart(ctxTendencia, {
            type: 'line',
            data: {
                labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6', 'Sem 7', 'Sem 8', 'Sem 9', 'Sem 10', 'Sem 11', 'Sem 12'],
                datasets: [
                    {
                        label: 'Tickets Creados',
                        data: [85, 92, 78, 95, 88, 105, 98, 110, 92, 88, 95, 102],
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Tickets Resueltos',
                        data: [82, 90, 75, 92, 85, 102, 96, 108, 90, 86, 93, 100],
                        borderColor: 'rgba(56, 239, 125, 1)',
                        backgroundColor: 'rgba(56, 239, 125, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        labels: { color: 'white', font: { size: 14 } }
                    }
                },
                scales: {
                    y: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });

        // Gráfico de Tipos
        const ctxTipos = document.getElementById('chartTipos').getContext('2d');
        new Chart(ctxTipos, {
            type: 'doughnut',
            data: {
                labels: ['Incidentes', 'Requerimientos', 'Consultas', 'Problemas'],
                datasets: [{
                    data: [512, 385, 278, 70],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(56, 239, 125, 0.8)',
                        'rgba(242, 153, 74, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: 'white', padding: 15 }
                    }
                }
            }
        });

        // Gráfico SLA
        const ctxSLA = document.getElementById('chartSLA').getContext('2d');
        new Chart(ctxSLA, {
            type: 'bar',
            data: {
                labels: ['Banco Central', 'Financiera Alfa', 'Grupo Innova', 'Otros Clientes'],
                datasets: [{
                    label: 'Cumplimiento SLA (%)',
                    data: [98.2, 97.5, 96.8, 97.1],
                    backgroundColor: 'rgba(56, 239, 125, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: 'white' } }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { display: false }
                    }
                }
            }
        });

        // Gráfico Tiempos
        const ctxTiempos = document.getElementById('chartTiempos').getContext('2d');
        new Chart(ctxTiempos, {
            type: 'horizontalBar',
            data: {
                labels: ['Crítica', 'Alta', 'Media', 'Baja'],
                datasets: [{
                    label: 'Tiempo Promedio (horas)',
                    data: [1.2, 3.8, 6.5, 18.2],
                    backgroundColor: [
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(242, 153, 74, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(168, 168, 168, 0.8)'
                    ]
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: 'rgba(255, 255, 255, 0.7)' },
                        grid: { display: false }
                    }
                }
            }
        });

        // Funciones de Exportación
        function exportarExcel(tipo) {
            alert(`Generando reporte Excel: ${tipo}...\nFormato: .xlsx
            \nEste archivo se descargará automáticamente.`);
        }

        function exportarPDF(tipo) {
            alert(`Generando reporte PDF: ${tipo}...\nFormato: .pdf\nEste archivo se descargará automáticamente.`);
        }

        function exportarCSV(tipo) {
            alert(`Generando archivo CSV: ${tipo}...\nFormato: .csv\nDatos crudos para análisis en herramientas externas.`);
        }

        function exportarPersonalizado() {
            const inicio = document.getElementById('fechaInicio').value;
            const fin = document.getElementById('fechaFin').value;
            const formato = document.getElementById('formatoExport').value;
            
            if (!inicio || !fin) {
                alert('Por favor seleccione el rango de fechas');
                return;
            }
            
            alert(`Generando reporte personalizado:\nDesde: ${inicio}\nHasta: ${fin}\nFormato: ${formato}\n\nEl archivo se descargará en breve.`);
        }

        function generarReporte() {
            alert('Actualizando reportes con los filtros seleccionados...');
        }
    </script>
</body>
</html>